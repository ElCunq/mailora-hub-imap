<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Basit Mail İstemcisi</title>
<style>
body { margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif; background:#0f1217; color:#e5e7eb; height:100vh; display:flex; }
#app { flex:1; display:grid; grid-template-columns:260px 1fr 1fr; grid-template-rows:100%; }
.sidebar { border-right:1px solid #1f2937; padding:12px; background:#111827; overflow-y:auto; }
.sidebar h2 { font-size:14px; margin:12px 0 6px; color:#94a3b8; }
.account-item { padding:6px 8px; border-radius:6px; cursor:pointer; font-size:13px; margin-bottom:4px; background:#1b2230; }
.account-item.active { background:#2563eb; }
.folder-item { padding:4px 8px; font-size:12px; border-radius:5px; cursor:pointer; margin-bottom:3px; background:#1f2937; }
.folder-item.active { background:#374151; }
.panel { border-right:1px solid #1f2937; display:flex; flex-direction:column; }
.messages-panel { background:#0f141c; }
.toolbar { padding:8px 10px; border-bottom:1px solid #1f2937; display:flex; gap:8px; align-items:center; }
.toolbar input { flex:1; background:#1f2937; border:1px solid #334155; color:#e5e7eb; padding:6px 8px; border-radius:6px; font-size:13px; }
button { background:#1f2937; border:1px solid #334155; color:#e5e7eb; padding:6px 10px; font-size:12px; border-radius:6px; cursor:pointer; }
button:hover { background:#243043; }
#message-list { flex:1; overflow-y:auto; }
.message-row { padding:8px 10px; border-bottom:1px solid #1f2937; cursor:pointer; display:grid; grid-template-columns:160px 1fr 90px; gap:12px; font-size:12px; }
.message-row.unread { background:#182335; font-weight:600; }
.message-row:hover { background:#1f2937; }
.preview-panel { display:flex; flex-direction:column; }
#preview { flex:1; padding:12px; overflow-y:auto; }
#compose { border-top:1px solid #1f2937; padding:10px; background:#111827; }
#compose input, #compose textarea { width:100%; background:#1f2937; border:1px solid #334155; color:#e5e7eb; padding:6px 8px; font-size:13px; border-radius:6px; margin-bottom:6px; }
.badge { background:#374151; padding:2px 6px; border-radius:4px; font-size:10px; margin-left:4px; }
.small { font-size:11px; color:#94a3b8; }
.empty { text-align:center; padding:30px; color:#6b7280; font-size:13px; }
.unified-toggle { margin-top:10px; display:flex; align-items:center; gap:6px; font-size:12px; }
/* New: compact inline row for ports */
.inline-row { display:flex; gap:8px; align-items:center; margin-top:6px; }
.port-input { max-width: 120px; }
</style>
</head>
<body>
<div id="app">
  <div class="sidebar" id="accounts-sidebar">
    <h2>Hesaplar</h2>
    <div id="accounts"></div>
    <h2 style="margin-top:16px;">Hesap Ekle</h2>
    <input id="new-email" placeholder="email" />
    <input id="new-pass" type="password" placeholder="şifre/app pass" />
    <input id="new-imap" placeholder="imap host" />
    <input id="new-smtp" placeholder="smtp host" />
    <!-- New inline ports row below all fields -->
    <div class="inline-row">
      <input id="new-imap-port" class="port-input" placeholder="imap port" value="993" />
      <input id="new-smtp-port" class="port-input" placeholder="smtp port" value="587" />
    </div>
    <button onclick="addAccountSimple()">Ekle</button>
    <div id="add-result" class="small"></div>
    <h2 style="margin-top:16px;">Klasörler</h2>
    <div id="folders"></div>
    <div class="unified-toggle">
      <input type="checkbox" id="unified-check" onchange="refreshMessages()" />
      <label for="unified-check">Unified görünüm</label>
    </div>
  </div>
  <div class="panel messages-panel">
    <div class="toolbar">
      <input id="search" placeholder="Ara (konu / from)" oninput="filterMessages()" />
      <button onclick="refreshMessages()">Yenile</button>
      <button onclick="markSelectedSeen()">Okundu</button>
      <button onclick="deleteSelected()">Sil</button>
    </div>
    <div id="message-list"></div>
  </div>
  <div class="panel preview-panel">
    <div id="preview"><div class="empty">Mesaj seçin...</div></div>
    <div id="compose">
      <div style="display:flex; gap:6px;">
        <input id="compose-to" placeholder="Kime" />
        <input id="compose-subject" placeholder="Konu" />
        <button onclick="sendMail()">Gönder</button>
      </div>
      <textarea id="compose-body" rows="6" placeholder="İçerik..."></textarea>
      <div id="send-result" class="small"></div>
    </div>
  </div>
</div>
<script>
let accounts=[]; let currentAccount=null; let messages=[]; let filtered=[]; let currentFolder='INBOX'; let selectedUids=new Set();
function el(id){return document.getElementById(id);} // helper
async function loadAccounts(){ try{ const r=await fetch('/accounts'); accounts=await r.json(); renderAccounts(); if(!currentAccount && accounts.length){selectAccount(accounts[0].id);} }catch(e){ console.error(e);} }
function renderAccounts(){ el('accounts').innerHTML=(accounts.length? accounts.map(a=>`<div class="account-item ${a.id===currentAccount?'active':''}" onclick="selectAccount('${a.id}')">${a.email}<span class="badge">${(a.provider||'custom').toString().toUpperCase()}</span></div>`).join(''):'<div class="empty">Hesap yok</div>'); }
function selectAccount(id){ currentAccount=id; renderAccounts(); loadFolders(); refreshMessages(); }
async function loadFolders(){ const base=['INBOX','Sent','Drafts','Spam','Trash']; el('folders').innerHTML=base.map(f=>`<div class="folder-item ${f===currentFolder?'active':''}" onclick="selectFolder('${f}')">${f}</div>`).join(''); }
function selectFolder(f){ currentFolder=f; refreshMessages(); }
async function refreshMessages(){ try { const unified = el('unified-check').checked; if (unified) { // unified across accounts for folder
    const r = await fetch(`/unified/inbox?folder=${encodeURIComponent(currentFolder)}&limit=500`); const data = await r.json(); messages = data.messages.map(m=>({ uid:m.uid, from:m.from_addr||'', subject:m.subject||'', flags:m.flags||'', account_id:m.account_id })); filtered=messages; renderMessages(); return; }
    if(!currentAccount) return; const limit=200; const r=await fetch(`/test/messages/${currentAccount}?limit=${limit}&folder=${encodeURIComponent(currentFolder)}`); const data=await r.json(); messages=data.messages||[]; filtered=messages; selectedUids.clear(); renderMessages(); }catch(e){ console.error(e);} }
function filterMessages(){ const q=el('search').value.toLowerCase(); filtered=messages.filter(m=> (m.subject||'').toLowerCase().includes(q) || (m.from||'').toLowerCase().includes(q)); renderMessages(); }
function renderMessages(){ el('message-list').innerHTML = (filtered.length? filtered.map(m=>{ const seen=(m.flags||'').includes('\\Seen'); const acc=(m.account_id?`<span class='badge'>${m.account_id.split('_')[1]||''}</span>`:''); return `<div class="message-row ${seen?'':'unread'}" onclick="openMessage(${m.uid}, '${m.account_id||currentAccount}')"> <div>${(m.from||'').slice(0,22)} ${acc}</div><div>${(decodeSubject(m.subject||'(No subject)')).slice(0,60)}</div><div style='text-align:right;'>${m.uid}</div></div>`; }).join(''):'<div class="empty">Mesaj yok</div>'); }
async function openMessage(uid, accId){ const useAcc = accId || currentAccount; if(!useAcc) return; try{ const r=await fetch(`/test/body/${useAcc}/${uid}`); const body= await r.json(); el('preview').innerHTML = `<h3>${decodeSubject(body.subject||'(No subject)')}</h3><div class='small'>From: ${body.from} | UID: ${uid} | ${useAcc}</div><hr><div style='white-space:pre-wrap;font-size:13px;'>${body.plain_text || '(içerik yok)'}</div>`; selectedUids.clear(); selectedUids.add(uid); }catch(e){ el('preview').innerHTML='<div class="empty">Body alınamadı</div>'; }}
function decodeSubject(s){ try { return decodeURIComponent(escape(s)); } catch { return s; } }
async function markSelectedSeen(){ for(const uid of selectedUids){ await updateFlags(uid,{seen:true}); } refreshMessages(); }
async function deleteSelected(){ if(!confirm('Silinsin mi?')) return; for(const uid of selectedUids){ await updateFlags(uid,{deleted:true}); } refreshMessages(); }
async function updateFlags(uid,{seen=false,flagged=false,deleted=false}){ if(!currentAccount) return; try{ await fetch(`/messages/${encodeURIComponent(currentAccount)}/${encodeURIComponent(currentFolder)}/${encodeURIComponent(uid)}/flags`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({seen,flagged,deleted})}); }catch(e){ console.error('flags',e);} }
async function sendMail(){ if(!currentAccount){ el('send-result').textContent='Hesap yok'; return; } const to=el('compose-to').value.trim(); const subject=el('compose-subject').value.trim(); const body=el('compose-body').value; if(!to||!subject||!body){ el('send-result').textContent='Alanlar gerekli'; return; } el('send-result').textContent='Gönderiliyor...'; try{ const r=await fetch(`/test/smtp-append/${currentAccount}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({to,subject,body})}); const j=await r.json(); el('send-result').textContent=j.ok? 'Gönderildi':'Hata: '+(j.error||''); if(j.ok){ el('compose-body').value=''; refreshMessages(); }}catch(e){ el('send-result').textContent='Gönderim hatası'; }}
async function addAccountSimple(){ const email=el('new-email').value.trim(); const pass=el('new-pass').value.trim(); const imap=el('new-imap').value.trim(); const smtp=el('new-smtp').value.trim(); const imapPort=parseInt(el('new-imap-port').value.trim()||'993'); const smtpPort=parseInt(el('new-smtp-port').value.trim()||'587'); if(!email||!pass||!imap||!smtp){ el('add-result').textContent='Eksik alan'; return; } el('add-result').textContent='Ekleniyor...'; try{ const r=await fetch('/accounts',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email,password:pass,provider:'custom',imap_host:imap,imap_port:imapPort,smtp_host:smtp,smtp_port:smtpPort})}); const j=await r.json(); el('add-result').textContent=j.success?'Eklendi':'Hata'; loadAccounts(); }catch(e){ el('add-result').textContent='Hata'; }}
window.addEventListener('keydown',e=>{ if(e.key==='r' && e.ctrlKey){ e.preventDefault(); refreshMessages(); }});
loadAccounts();
</script>
</body>
</html>
