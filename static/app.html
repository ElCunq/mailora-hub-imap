<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mailora Hub - Email Management</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f1217;
            min-height: 100vh;
            padding: 20px;
            color: #e5e7eb;
    }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: #1b2230;
            border-radius: 12px;
            border: 1px solid #243043;
            overflow: hidden;
        }
        
        header {
            background: #111827;
            color: #e5e7eb;
            padding: 24px;
            text-align: center;
            border-bottom: 1px solid #1f2937;
        }
        
        header h1 {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #e5e7eb;
        }
        
        header p {
            opacity: 0.8;
            font-size: 14px;
            color: #94a3b8;
        }
        
        .tabs {
            display: flex;
            background: #111827;
            border-bottom: 1px solid #1f2937;
            overflow-x: auto;
        }
        
        .tab {
            padding: 12px 20px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 14px;
            font-weight: 500;
            color: #94a3b8;
            transition: all 0.2s;
            white-space: nowrap;
        }
        
        .tab:hover {
            background: #1f2937;
            color: #e5e7eb;
        }
        
        .tab.active {
            color: #60a5fa;
            border-bottom: 2px solid #60a5fa;
            background: #1b2230;
        }
        
        .tab-content {
            display: none;
            padding: 24px;
            background: #1b2230;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .account-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }
        
        .account-card {
            background: #111827;
            border: 1px solid #1f2937;
            border-radius: 8px;
            padding: 16px;
            transition: transform 0.2s, border-color 0.2s;
        }
        
        .account-card:hover {
            transform: translateY(-2px);
            border-color: #334155;
        }
        
        .account-card h3 {
            font-size: 16px;
            margin-bottom: 8px;
            color: #e5e7eb;
        }
        
        .account-card .email {
            color: #60a5fa;
            font-weight: 500;
            margin-bottom: 8px;
        }
        
        .account-card .provider {
            display: inline-block;
            background: #1f2937;
            color: #94a3b8;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            margin-bottom: 12px;
            border: 1px solid #334155;
        }
        
        .btn {
            padding: 8px 16px;
            border: 1px solid #334155;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            margin-right: 8px;
            margin-top: 8px;
            background: #111827;
            color: #e5e7eb;
        }
        
        .btn:hover {
            border-color: #475569;
            background: #1f2937;
        }
        
        .btn-primary {
            background: #1e40af;
            border-color: #1e40af;
            color: white;
        }
        
        .btn-primary:hover {
            background: #1e3a8a;
            border-color: #1e3a8a;
        }
        
        .btn-success {
            background: #047857;
            border-color: #047857;
            color: white;
        }
        
        .btn-success:hover {
            background: #065f46;
            border-color: #065f46;
        }
        
        .btn-danger {
            background: #b91c1c;
            border-color: #b91c1c;
            color: white;
        }
        
        .btn-danger:hover {
            background: #991b1b;
            border-color: #991b1b;
        }
        
        .btn-secondary {
            background: #374151;
            border-color: #4b5563;
            color: #d1d5db;
        }
        
        .btn-secondary:hover {
            background: #4b5563;
            border-color: #6b7280;
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #94a3b8;
            font-size: 12px;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #334155;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s;
            background: #111827;
            color: #e5e7eb;
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #60a5fa;
        }
        
        .message-list {
            background: #111827;
            border: 1px solid #1f2937;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 16px;
        }
        
        .message-item {
            padding: 12px;
            border-bottom: 1px solid #1f2937;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .message-item:hover {
            background: #1f2937;
        }
        
        .message-item:last-child {
            border-bottom: none;
        }
        
        .message-subject {
            font-weight: 500;
            color: #e5e7eb;
            margin-bottom: 4px;
        }
        
        .message-from {
            color: #60a5fa;
            font-size: 13px;
            margin-bottom: 4px;
        }
        
        .message-date {
            color: #6b7280;
            font-size: 12px;
        }
        
        .message-body-view {
            background: #111827;
            border: 1px solid #1f2937;
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }
        
        .spinner {
            border: 3px solid #1f2937;
            border-top: 3px solid #60a5fa;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .event-log {
            background: #0b0e13;
            color: #e5e7eb;
            padding: 16px;
            border-radius: 8px;
            max-height: 500px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            border: 1px solid #1f2937;
        }
        
        .event-item {
            padding: 8px;
            border-bottom: 1px solid #1f2937;
            margin-bottom: 8px;
        }
        
        .event-item.new {
            background: #1f2937;
            animation: highlight 0.5s;
        }
        
        @keyframes highlight {
            from { background: #047857; }
            to { background: #1f2937; }
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-active {
            background: #047857;
            color: white;
        }
        
        .status-inactive {
            background: #374151;
            color: #9ca3af;
        }
        
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        @media (max-width: 768px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }
        }
        
        pre {
            background: #0b0e13;
            padding: 12px;
            border-radius: 8px;
            overflow: auto;
            font-size: 13px;
            border: 1px solid #1f2937;
            color: #e5e7eb;
        }
        
        textarea {
            background: #111827;
            border: 1px solid #334155;
            color: #e5e7eb;
            border-radius: 8px;
            padding: 10px;
            font-family: system-ui, -apple-system, sans-serif;
            resize: vertical;
        }
        
        textarea:focus {
            outline: none;
            border-color: #60a5fa;
        }
        
        h2 {
            color: #e5e7eb;
            margin-bottom: 16px;
            font-size: 18px;
        }
        
        h3 {
            color: #d1d5db;
        }
        
        header h1 {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #e5e7eb;
        }
        
        header p {
            opacity: 0.8;
            font-size: 14px;
            color: #94a3b8;
        }
        
        .tabs {
            display: flex;
            background: #111827;
            border-bottom: 1px solid #1f2937;
            overflow-x: auto;
        }
        
        .tab {
            padding: 12px 20px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 14px;
            font-weight: 500;
            color: #94a3b8;
            transition: all 0.2s;
            white-space: nowrap;
        }
        
        .tab:hover {
            background: #1f2937;
            color: #e5e7eb;
        }
        
        .tab.active {
            color: #60a5fa;
            border-bottom: 2px solid #60a5fa;
            background: #1b2230;
        }
        
        .tab-content {
            display: none;
            padding: 24px;
            background: #1b2230;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .account-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }
        
        .account-card {
            background: #111827;
            border: 1px solid #1f2937;
            border-radius: 8px;
            padding: 16px;
            transition: transform 0.2s, border-color 0.2s;
        }
        
        .account-card:hover {
            transform: translateY(-2px);
            border-color: #334155;
        }
        
        .account-card h3 {
            font-size: 16px;
            margin-bottom: 8px;
            color: #e5e7eb;
        }
        
        .account-card .email {
            color: #60a5fa;
            font-weight: 500;
            margin-bottom: 8px;
        }
        
        .account-card .provider {
            display: inline-block;
            background: #1f2937;
            color: #94a3b8;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            margin-bottom: 12px;
            border: 1px solid #334155;
        }
        
        .btn {
            padding: 8px 16px;
            border: 1px solid #334155;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            margin-right: 8px;
            margin-top: 8px;
            background: #111827;
            color: #e5e7eb;
        }
        
        .btn:hover {
            border-color: #475569;
            background: #1f2937;
        }
        
        .btn-primary {
            background: #1e40af;
            border-color: #1e40af;
            color: white;
        }
        
        .btn-primary:hover {
            background: #1e3a8a;
            border-color: #1e3a8a;
        }
        
        .btn-success {
            background: #047857;
            border-color: #047857;
            color: white;
        }
        
        .btn-success:hover {
            background: #065f46;
            border-color: #065f46;
        }
        
        .btn-danger {
            background: #b91c1c;
            border-color: #b91c1c;
            color: white;
        }
        
        .btn-danger:hover {
            background: #991b1b;
            border-color: #991b1b;
        }
        
        .btn-secondary {
            background: #374151;
            border-color: #4b5563;
            color: #d1d5db;
        }
        
        .btn-secondary:hover {
            background: #4b5563;
            border-color: #6b7280;
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #94a3b8;
            font-size: 12px;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #334155;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s;
            background: #111827;
            color: #e5e7eb;
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #60a5fa;
        }
        
        .message-list {
            background: #111827;
            border: 1px solid #1f2937;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 16px;
        }
        
        .message-item {
            padding: 12px;
            border-bottom: 1px solid #1f2937;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .message-item:hover {
            background: #1f2937;
        }
        
        .message-item:last-child {
            border-bottom: none;
        }
        
        .message-subject {
            font-weight: 500;
            color: #e5e7eb;
            margin-bottom: 4px;
        }
        
        .message-from {
            color: #60a5fa;
            font-size: 13px;
            margin-bottom: 4px;
        }
        
        .message-date {
            color: #6b7280;
            font-size: 12px;
        }
        
        .message-body-view {
            background: #111827;
            border: 1px solid #1f2937;
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }
        
        .spinner {
            border: 3px solid #1f2937;
            border-top: 3px solid #60a5fa;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .event-log {
            background: #0b0e13;
            color: #e5e7eb;
            padding: 16px;
            border-radius: 8px;
            max-height: 500px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            border: 1px solid #1f2937;
        }
        
        .event-item {
            padding: 8px;
            border-bottom: 1px solid #1f2937;
            margin-bottom: 8px;
        }
        
        .event-item.new {
            background: #1f2937;
            animation: highlight 0.5s;
        }
        
        @keyframes highlight {
            from { background: #047857; }
            to { background: #1f2937; }
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-active {
            background: #047857;
            color: white;
        }
        
        .status-inactive {
            background: #374151;
            color: #9ca3af;
        }
        
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        @media (max-width: 768px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }
        }
        
        pre {
            background: #0b0e13;
            padding: 12px;
            border-radius: 8px;
            overflow: auto;
            font-size: 13px;
            border: 1px solid #1f2937;
            color: #e5e7eb;
        }
        
        textarea {
            background: #111827;
            border: 1px solid #334155;
            color: #e5e7eb;
            border-radius: 8px;
            padding: 10px;
            font-family: system-ui, -apple-system, sans-serif;
            resize: vertical;
        }
        
        textarea:focus {
            outline: none;
            border-color: #60a5fa;
        }
        
        h2 {
            color: #e5e7eb;
            margin-bottom: 16px;
            font-size: 18px;
        }
        
        h3 {
            color: #d1d5db;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìß Mailora Hub</h1>
            <p>Multi-Account Email Management System</p>
        </header>
        
        <div class="tabs">
            <button class="tab active" data-tab="accounts">üì• Hesaplar</button>
            <button class="tab" data-tab="messages">‚úâÔ∏è Mesajlar</button>
            <button class="tab" data-tab="add-account">‚ûï Hesap Ekle</button>
            <button class="tab" data-tab="idle">üîî Real-time (IDLE)</button>
            <button class="tab" data-tab="test">üß™ Test</button>
        </div>
        
        <div id="accounts" class="tab-content active">
            <h2>Email Hesaplarƒ±m</h2>
            <div class="loading" id="accounts-loading">
                <div class="spinner"></div>
                <p>Hesaplar y√ºkleniyor...</p>
            </div>
            <div class="account-grid" id="account-grid"></div>
        </div>
        
        <div id="messages" class="tab-content">
            <h2>Mesajlarƒ±m</h2>
            <div class="form-group">
                <label>Hesap Se√ß:</label>
                <select id="message-account-select">
                    <option value="">Hesap se√ßin...</option>
                </select>
            </div>
            <div class="form-group">
                <label>Mesaj Sayƒ±sƒ±:</label>
                <input type="number" id="message-limit" value="10" min="1" max="50">
                <button class="btn btn-primary" onclick="loadMessages()">Gelen Kutusu</button>
                <button class="btn btn-secondary" onclick="loadJunkMessages()">Junk (Spam)</button>
            </div>
            <div class="message-list" id="message-list"></div>
            <div class="message-body-view" id="message-body-view" style="display:none;"></div>
        </div>
        
        <div id="add-account" class="tab-content">
            <h2 style="margin-top:32px;color:#10b981;">JMAP Baƒülantƒ± & Test</h2>
            <div class="form-group">
                <label>JMAP API URL:</label>
                <input type="text" id="jmap-api-url" placeholder="https://mail.example.com/jmap">
            </div>
            <div class="form-group">
                <label>API Token:</label>
                <input type="text" id="jmap-api-token" placeholder="Bearer Token">
            </div>
            <div class="form-group">
                <label>Account ID:</label>
                <input type="text" id="jmap-account-id" placeholder="user-account-id">
            </div>
            <button class="btn btn-primary" onclick="testJmapConnection()">JMAP Baƒülantƒ± Testi</button>
            <button class="btn btn-secondary" onclick="testJmapInbox()">Inbox Mesajlarƒ±nƒ± Getir</button>
            <pre id="jmap-test-result" style="margin-top:12px;display:none;"></pre>
            <h2>Yeni Hesap Ekle</h2>
            
            <!-- Provider Info Banner -->
            <div id="provider-info" style="background: #1f2937; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #10b981;">
                <h3 style="margin-bottom: 8px; font-size: 14px;">‚ÑπÔ∏è √ñnemli Bilgi</h3>
                <p id="provider-info-text" style="font-size: 13px; color: #94a3b8; line-height: 1.6;">
                    <strong>Gmail Kurulumu:</strong><br>
                    <strong>Y√∂ntem 1 (√ñnerilen):</strong> OAuth2 ile Giri≈ü butonu (≈ûifre gerektirmez)<br>
                    <strong>Y√∂ntem 2:</strong> App Password kullan
                </p>
            </div>
            
            <div class="form-group">
                <!-- Provider se√ßimi devre dƒ±≈üƒ±: Sadece Gmail/App Password -->
            </div>
            
            <!-- OAuth2 Login Button (Gmail Only) -->
            <!-- OAuth2 login devre dƒ±≈üƒ± -->
            
            <div style="text-align: center; margin: 15px 0; color: #6b7280; font-size: 13px;">
                veya App Password ile manuel ekle ‚Üì
            </div>
            
            <div class="form-group">
                <label>Email:</label>
                <input type="email" id="new-email" placeholder="your@email.com">
            </div>
            <div class="form-group">
                <label>IMAP Host:</label>
                <input type="text" id="new-imap-host" placeholder="imap.example.com">
            </div>
            <div class="form-group">
                <label>IMAP Port:</label>
                <input type="number" id="new-imap-port" value="993">
            </div>
            <div class="form-group">
                <label>SMTP Host:</label>
                <input type="text" id="new-smtp-host" placeholder="smtp.example.com">
            </div>
            <div class="form-group">
                <label>SMTP Port:</label>
                <input type="number" id="new-smtp-port" value="587">
            </div>
            <div class="form-group">
                <label>Password / App Password:</label>
                <input type="password" id="new-password" placeholder="App Password (16 karakter)">
                <small style="color: #6b7280; font-size: 12px; display: block; margin-top: 4px;">
                    ‚ö†Ô∏è Normal ≈üifre DEƒûƒ∞L, App Password kullanƒ±n
                </small>
            </div>
            <div class="form-group">
                <label>Display Name (opsiyonel):</label>
                <input type="text" id="new-display-name" placeholder="ƒ∞≈ü Hesabƒ±">
            </div>
                <div id="custom-fields" style="display:none;">
                    <!-- Custom provider alanlarƒ± devre dƒ±≈üƒ±: Sadece d√ºz IMAP/SMTP -->
                </div>
            </div>
            <button class="btn btn-success" onclick="addAccount()">‚úÖ Hesap Ekle</button>
            <pre id="add-account-result" style="margin-top:20px;display:none;"></pre>
        </div>
        
        <div id="idle" class="tab-content">
            <h2>Real-time Email Notifications (IDLE)</h2>
            <div class="form-group">
                <label>Hesap Se√ß:</label>
                <select id="idle-account-select">
                    <option value="">Hesap se√ßin...</option>
                </select>
            </div>
            <button class="btn btn-success" onclick="startIdleWatcher()">üü¢ IDLE Ba≈ülat</button>
            <button class="btn btn-danger" onclick="stopIdleWatcher()">üî¥ IDLE Durdur</button>
            <button class="btn btn-secondary" onclick="checkIdleStatus()">üìä Durum</button>
            
            <h3 style="margin-top:30px;">Event Log (Real-time)</h3>
            <div class="event-log" id="event-log">
                <div style="color:#48bb78;">‚úì Event stream baƒülantƒ±sƒ± bekleniyor...</div>
            </div>
        </div>
        
        <div id="test" class="tab-content">
            <h2>Test & Debug</h2>
            <div class="form-group">
                <label>Test Account:</label>
                <select id="test-account-select">
                    <option value="">Hesap se√ßin...</option>
                </select>
            </div>
            <button class="btn btn-primary" onclick="testConnection()">üîå IMAP Baƒülantƒ± Testi</button>
            <button class="btn btn-secondary" onclick="loadTestAccounts()">üìã Hesap Listesi</button>
            <hr style="margin:24px 0;">
            <h3>SMTP Testi (lettre)</h3>
            <div class="form-group">
                <label>Alƒ±cƒ± Email:</label>
                <input type="email" id="smtp-test-to" placeholder="test@email.com">
            </div>
            <div class="form-group">
                <label>Konu:</label>
                <input type="text" id="smtp-test-subject" placeholder="Test Konusu">
            </div>
            <div class="form-group">
                <label>Mesaj:</label>
                <textarea id="smtp-test-body" rows="3" placeholder="Test mesajƒ± i√ßeriƒüi..."></textarea>
            </div>
            <button class="btn btn-success" onclick="sendSmtpTest()">üì§ SMTP ile Test Mail G√∂nder</button>
            <pre id="smtp-test-result" style="margin-top:12px;"></pre>

            <!-- SMTP + APPEND (Sent) Testi -->
            <hr style="margin:24px 0;">
            <h3>SMTP + APPEND (Sent Kopyasƒ±)</h3>
            <div class="form-group">
                <label>Alƒ±cƒ± Email:</label>
                <input type="email" id="smtp-append-to" placeholder="test@email.com">
            </div>
            <div class="form-group">
                <label>Konu:</label>
                <input type="text" id="smtp-append-subject" placeholder="Test Konusu">
            </div>
            <div class="form-group">
                <label>Mesaj:</label>
                <textarea id="smtp-append-body" rows="3" placeholder="Test mesajƒ± i√ßeriƒüi..."></textarea>
            </div>
            <button class="btn btn-primary" onclick="sendSmtpAppendTest()">üì§ G√∂nder ve Sent'e Kaydet</button>
            <pre id="smtp-append-result" style="margin-top:12px;"></pre>

            <!-- Flags G√ºncelleme Testi -->
            <hr style="margin:24px 0;">
            <h3>Mesaj Bayraklarƒ± (Flags) G√ºncelle</h3>
            <div class="form-group">
                <label>Klas√∂r Adƒ±:</label>
                <input type="text" id="flags-folder" placeholder="√ñrn: INBOX veya [Gmail]/Sent Mail">
            </div>
            <div class="form-group">
                <label>UID:</label>
                <input type="number" id="flags-uid" placeholder="√ñrn: 1234">
            </div>
            <div class="form-group">
                <label><input type="checkbox" id="flags-seen"> Seen (\\Seen)</label>
            </div>
            <div class="form-group">
                <label><input type="checkbox" id="flags-flagged"> Flagged (\\Flagged)</label>
            </div>
            <div class="form-group">
                <label><input type="checkbox" id="flags-deleted"> Deleted (\\Deleted)</label>
            </div>
            <button class="btn btn-secondary" onclick="updateMessageFlags()">üîñ Bayraklarƒ± G√ºncelle</button>
            <pre id="flags-result" style="margin-top:12px;"></pre>
        </div>
    </div>

    <script>
        async function loadJunkMessages() {
            const accountId = document.getElementById('message-account-select').value;
            const limit = document.getElementById('message-limit').value;
            if (!accountId) {
                alert('√ñnce hesap se√ßin!');
                return;
            }
            try {
                const res = await fetch(`/test/messages/${accountId}?limit=${limit}&folder=Junk Mail`);
                const data = await res.json();
                currentMessages = data.messages;
                const listEl = document.getElementById('message-list');
                listEl.innerHTML = currentMessages.map((msg, idx) => `
                    <div class="message-item" onclick="viewMessage(${idx})">
                        <div class="message-subject">${decodeSubject(msg.subject)}</div>
                        <div class="message-from">From: ${msg.from}</div>
                        <div class="message-date">${msg.date || 'No date'}</div>
                    </div>
                `).join('');
            } catch (e) {
                console.error('Junk messages failed:', e);
            }
        }
        // Sync account messages (global scope)
        async function syncAccount(accountId) {
            if (!confirm('Bu hesabƒ±n t√ºm klas√∂rlerini sync etmek istiyor musunuz? Bu i≈ülem birka√ß dakika s√ºrebilir.')) {
                return;
            }
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = '‚è≥ Syncing...';
            try {
                const res = await fetch(`/sync/${accountId}`, { method: 'POST' });
                const result = await res.json();
                alert(`Sync tamamlandƒ±!\n\n` +
                    `Yeni: ${result.total_new}\n` +
                    `G√ºncellenen: ${result.total_updated}\n` +
                    `Silinen: ${result.total_deleted}\n\n` +
                    `Klas√∂rler: ${result.stats.length}`
                );
                btn.textContent = '‚úÖ Synced!';
                setTimeout(() => {
                    btn.textContent = 'üîÑ Sync';
                    btn.disabled = false;
                }, 2000);
            } catch (e) {
                alert('Sync hatasƒ±: ' + e.message);
                btn.textContent = 'üîÑ Sync';
                btn.disabled = false;
            }
        }
        let accounts = [];
        let currentMessages = [];
        
        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(tab.dataset.tab).classList.add('active');
            });
        });
        
        // Load accounts on page load
        async function loadAccounts() {
            try {
                const res = await fetch('/accounts');
                accounts = await res.json();
                
                document.getElementById('accounts-loading').style.display = 'none';
                
                const grid = document.getElementById('account-grid');
                grid.innerHTML = accounts.map(acc => `
                    <div class="account-card">
                        <h3>${acc.display_name || 'Email Account'}</h3>
                        <div class="email">${acc.email}</div>
                        <span class="provider">${acc.provider.toUpperCase()}</span>
                        <span class="status-badge ${acc.enabled ? 'status-active' : 'status-inactive'}">
                            ${acc.enabled ? 'Active' : 'Disabled'}
                        </span>
                        <div style="margin-top:15px;">
                            <button class="btn btn-primary" onclick="syncAccount('${acc.id}')">
                                ÔøΩ Sync
                            </button>
                            <button class="btn btn-success" onclick="viewAccountMessages('${acc.id}')">
                                ‚úâÔ∏è Messages
                            </button>
                            <button class="btn btn-danger" onclick="deleteAccount('${acc.id}')">
                                üóëÔ∏è Delete
                            </button>
                        </div>
                    </div>
                `).join('');
                
                // Populate selects
                const selectHtml = accounts.map(acc => 
                    `<option value="${acc.id}">${acc.email}</option>`
                ).join('');
                
                document.getElementById('message-account-select').innerHTML = 
                    '<option value="">Hesap se√ßin...</option>' + selectHtml;
                document.getElementById('idle-account-select').innerHTML = 
                    '<option value="">Hesap se√ßin...</option>' + selectHtml;
                document.getElementById('test-account-select').innerHTML = 
                    '<option value="">Hesap se√ßin...</option>' + selectHtml;
                    
            } catch (e) {
                console.error('Failed to load accounts:', e);
            }
        }
        
        async function addAccount() {
            const email = document.getElementById('new-email').value;
            const password = document.getElementById('new-password').value;
            const display_name = document.getElementById('new-display-name').value;
            const imap_host = document.getElementById('new-imap-host').value;
            const imap_port = parseInt(document.getElementById('new-imap-port').value);
            const smtp_host = document.getElementById('new-smtp-host').value;
            const smtp_port = parseInt(document.getElementById('new-smtp-port').value);
            if (!email || !password || !imap_host || !imap_port || !smtp_host || !smtp_port) {
                alert('T√ºm alanlarƒ± doldurun!');
                return;
            }
            const body = { email, password, provider: 'custom', imap_host, imap_port, smtp_host, smtp_port };
            if (display_name) body.display_name = display_name;
            
            try {
                const res = await fetch('/accounts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                const resultEl = document.getElementById('add-account-result');
                resultEl.style.display = 'block';
                if (!res.ok) {
                    const text = await res.text();
                    resultEl.textContent = 'Hesap eklenirken hata: ' + text;
                    alert('Hesap eklenirken hata: ' + text);
                    return;
                }
                const result = await res.json();
                resultEl.textContent = JSON.stringify(result, null, 2);
                if (result.success) {
                    setTimeout(() => {
                        loadAccounts();
                        document.querySelector('.tab[data-tab="accounts"]').click();
                    }, 1000);
                }
            } catch (e) {
                console.error('Add account failed:', e);
                alert('Hesap eklenirken hata: ' + e.message);
            }
        }
        
        async function deleteAccount(id) {
            if (!confirm('Bu hesabƒ± silmek istediƒüinize emin misiniz?')) return;
            
            try {
                await fetch(`/accounts/${id}`, { method: 'DELETE' });
                loadAccounts();
            } catch (e) {
                console.error('Delete failed:', e);
            }
        }
        
        async function testAccountConnection(accountId) {
            try {
                const res = await fetch(`/test/connection/${accountId}`);
                const result = await res.json();
                alert(`Connection: ${result.success ? 'SUCCESS ‚úÖ' : 'FAILED ‚ùå'}\nFolders: ${result.folders.length}\nMessages: ${result.inbox_stats.exists}`);
            } catch (e) {
                alert('Test failed: ' + e.message);
            }
        }
        
        function viewAccountMessages(accountId) {
            document.getElementById('message-account-select').value = accountId;
            document.querySelector('.tab[data-tab="messages"]').click();
            loadMessages();
        }
        
        async function loadMessages() {
            const accountId = document.getElementById('message-account-select').value;
            const limit = document.getElementById('message-limit').value;
            
            if (!accountId) {
                alert('√ñnce hesap se√ßin!');
                return;
            }
            
            try {
                const res = await fetch(`/test/messages/${accountId}?limit=${limit}`);
                const data = await res.json();
                currentMessages = data.messages;
                
                const listEl = document.getElementById('message-list');
                listEl.innerHTML = currentMessages.map((msg, idx) => `
                    <div class="message-item" onclick="viewMessage(${idx})">
                        <div class="message-subject">${decodeSubject(msg.subject)}</div>
                        <div class="message-from">From: ${msg.from}</div>
                        <div class="message-date">${msg.date || 'No date'}</div>
                    </div>
                `).join('');
            } catch (e) {
                console.error('Load messages failed:', e);
            }
        }
        
        async function viewMessage(index) {
            const msg = currentMessages[index];
            const accountId = document.getElementById('message-account-select').value;
            
            try {
                const res = await fetch(`/test/body/${accountId}/${msg.uid}`);
                const body = await res.json();
                
                const viewEl = document.getElementById('message-body-view');
                viewEl.style.display = 'block';
                viewEl.innerHTML = `
                    <h3>${decodeSubject(body.subject)}</h3>
                    <p><strong>From:</strong> ${body.from}</p>
                    <p><strong>To:</strong> ${body.to}</p>
                    <p><strong>Date:</strong> ${body.date || 'N/A'}</p>
                    <hr style="margin:20px 0;">
                    <div style="white-space:pre-wrap;">${body.plain_text || body.html_text || 'No content'}</div>
                `;
                
                viewEl.scrollIntoView({ behavior: 'smooth' });
            } catch (e) {
                console.error('View message failed:', e);
            }
        }
        
        async function startIdleWatcher() {
            const accountId = document.getElementById('idle-account-select').value;
            if (!accountId) {
                alert('√ñnce hesap se√ßin!');
                return;
            }
            
            try {
                const res = await fetch(`/idle/start/${accountId}`, { method: 'POST' });
                const result = await res.json();
                addEventLog('success', result.message);
                
                // Start listening to events
                connectEventStream();
            } catch (e) {
                addEventLog('error', 'Failed to start IDLE: ' + e.message);
            }
        }
        
        async function stopIdleWatcher() {
            const accountId = document.getElementById('idle-account-select').value;
            if (!accountId) {
                alert('√ñnce hesap se√ßin!');
                return;
            }
            
            try {
                const res = await fetch(`/idle/stop/${accountId}`, { method: 'POST' });
                const result = await res.json();
                addEventLog('info', result.message);
            } catch (e) {
                addEventLog('error', 'Failed to stop IDLE: ' + e.message);
            }
        }
        
        async function checkIdleStatus() {
            try {
                const res = await fetch('/idle/status');
                const result = await res.json();
                addEventLog('info', `Active watchers: ${result.active_watchers}`);
            } catch (e) {
                addEventLog('error', 'Failed to check status: ' + e.message);
            }
        }
        
        function connectEventStream() {
            const eventSource = new EventSource('/idle/events');
            
            eventSource.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    addEventLog(data.event_type, `[${data.email}] ${JSON.stringify(data.event_type)}`);
                } catch (e) {
                    console.error('Event parse error:', e);
                }
            };
            
            eventSource.onerror = () => {
                addEventLog('error', 'Event stream connection lost');
            };
        }
        
        function addEventLog(type, message) {
            const logEl = document.getElementById('event-log');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'success' || type.new_message ? '#48bb78' : 
                         type === 'error' ? '#f56565' : '#e2e8f0';
            
            logEl.innerHTML = `<div class="event-item new" style="color:${color}">
                [${timestamp}] ${message}
            </div>` + logEl.innerHTML;
        }
        
        async function sendSmtpTest() {
            const accountId = document.getElementById('test-account-select').value;
            const to = document.getElementById('smtp-test-to').value;
            const subject = document.getElementById('smtp-test-subject').value;
            const body = document.getElementById('smtp-test-body').value;
            const resultEl = document.getElementById('smtp-test-result');

            if (!accountId || !to || !subject || !body) {
                alert('Hesap, alƒ±cƒ±, konu ve mesaj zorunlu!');
                return;
            }

            resultEl.textContent = 'G√∂nderiliyor...';
            try {
                const res = await fetch(`/test/smtp/${accountId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ to, subject, body })
                });
                const result = await res.json();
                resultEl.textContent = JSON.stringify(result, null, 2);
            } catch (e) {
                resultEl.textContent = 'SMTP g√∂nderim hatasƒ±: ' + e.message;
            }
        }

        async function sendSmtpAppendTest() {
          const accountId = document.getElementById('test-account-select')?.value;
          const to = document.getElementById('smtp-append-to').value;
          const subject = document.getElementById('smtp-append-subject').value;
          const body = document.getElementById('smtp-append-body').value;
          const out = document.getElementById('smtp-append-result');
          if (!accountId || !to || !subject || !body) { out.textContent = 'Hesap, alƒ±cƒ±, konu ve mesaj zorunlu!'; return; }
          out.textContent = 'G√∂nderiliyor...';
          try {
            const res = await fetch(`/test/smtp-append/${accountId}`, {
              method: 'POST', headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ to, subject, body })
            });
            const json = await res.json().catch(() => ({ ok: false, error: 'JSON parse failed' }));
            out.textContent = JSON.stringify(json, null, 2);
          } catch (e) {
            out.textContent = 'Hata: ' + e.message;
          }
        }

        async function updateMessageFlags() {
          const accountId = document.getElementById('test-account-select')?.value;
          const folder = document.getElementById('flags-folder').value;
          const uid = document.getElementById('flags-uid').value;
          const seen = document.getElementById('flags-seen').checked;
          const flagged = document.getElementById('flags-flagged').checked;
          const deleted = document.getElementById('flags-deleted').checked;
          const out = document.getElementById('flags-result');
          if (!accountId || !folder || !uid) { out.textContent = 'Hesap, klas√∂r ve UID zorunlu!'; return; }
          out.textContent = 'G√ºncelleniyor...';
          try {
            const res = await fetch(`/messages/${encodeURIComponent(accountId)}/${encodeURIComponent(folder)}/${encodeURIComponent(uid)}/flags`, {
              method: 'POST', headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ seen, flagged, deleted })
            });
            const json = await res.json().catch(() => ({ ok: false, error: 'JSON parse failed' }));
            out.textContent = JSON.stringify(json, null, 2);
          } catch (e) {
            out.textContent = 'Hata: ' + e.message;
          }
        }
        
        async function testConnection() {
            const accountId = document.getElementById('test-account-select').value;
            if (!accountId) {
                alert('√ñnce hesap se√ßin!');
                return;
            }
            try {
                const res = await fetch(`/test/connection/${accountId}`);
                const result = await res.json();
                document.getElementById('test-result').textContent = JSON.stringify(result, null, 2);
            } catch (e) {
                document.getElementById('test-result').textContent = 'Error: ' + e.message;
            }
        }
        
        async function loadTestAccounts() {
            try {
                const res = await fetch('/accounts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email,
                        password,
                        provider: 'custom',
                        display_name,
                        imap_host,
                        imap_port,
                        smtp_host,
                        smtp_port
                    })
                });
                let result;
                if (!res.ok || res.status !== 200) {
                    const text = await res.text();
                    result = { success: false, message: text };
                } else {
                    try {
                        result = await res.json();
                    } catch (e) {
                        const text = await res.text();
                        result = { success: false, message: text };
                    }
                }
                if (result.success) {
                    resultEl.style.display = 'block';
                    resultEl.textContent = 'Hesap ba≈üarƒ±yla eklendi!';
                    setTimeout(() => { resultEl.style.display = 'none'; }, 3000);
                    await loadAccounts();
                } else {
                    resultEl.style.display = 'block';
                    resultEl.textContent = 'Hesap eklenirken hata: ' + (result.message || 'Bilinmeyen hata');
                }
            } catch (e) {
                resultEl.style.display = 'block';
                resultEl.textContent = 'Hesap eklenirken hata: ' + (e.message || 'Bilinmeyen hata');
            }
        }

        // Hesap ekleme sonrasƒ± sync i≈ülemi
        async function syncAccountAfterAdd(accountId, event) {
            if (!confirm('Bu hesabƒ±n t√ºm klas√∂rlerini sync etmek istiyor musunuz? Bu i≈ülem birka√ß dakika s√ºrebilir.')) {
                return;
            }
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = '‚è≥ Syncing...';
            try {
                const res = await fetch(`/sync/${accountId}`, { method: 'POST' });
                const result = await res.json();
                alert(`Sync tamamlandƒ±!\n\n` +
                    `Yeni: ${result.total_new}\n` +
                    `G√ºncellenen: ${result.total_updated}\n` +
                    `Silinen: ${result.total_deleted}\n\n` +
                    `Klas√∂rler: ${result.stats.length}`
                );
                btn.textContent = '‚úÖ Synced!';
                setTimeout(() => {
                    btn.textContent = 'üîÑ Sync';
                    btn.disabled = false;
                }, 2000);
            } catch (e) {
                alert('Sync hatasƒ±: ' + e.message);
                btn.textContent = 'üîÑ Sync';
                btn.disabled = false;
            }
        
        
        // View account messages
        async function viewAccountMessages(accountId) {
            try {
                const res = await fetch(`/messages/${accountId}`);
                const result = await res.json();
                
                const messagesTab = document.querySelector('[data-tab="messages"]');
                messagesTab.click();
                
                document.getElementById('message-account-select').value = accountId;
                
                const messageList = document.getElementById('message-list');
                messageList.innerHTML = result.messages.map(msg => `
                    <div class="message-item">
                        <div class="message-subject">${decodeSubject(msg.subject || '(No subject)')}</div>
                        <div class="message-from">${msg.from_addr || 'Unknown'}</div>
                        <div class="message-date">${msg.date || ''} | ${msg.folder}</div>
                    </div>
                `).join('');
            } catch (e) {
                alert('Mesajlar y√ºklenemedi: ' + e.message);
            }
        }
        
        // OAuth2 Login
        async function loginWithOAuth() {
            // Provider mantƒ±ƒüƒ± devre dƒ±≈üƒ±: Sadece email ile √ßalƒ±≈üacak
            const email = document.getElementById('new-email').value.trim();
            if (!email) {
                alert('L√ºtfen √∂nce Gmail adresinizi girin!');
                return;
            }
            
            try {
                // Start OAuth flow
                const res = await fetch(`/oauth/start?provider=gmail`);
                const data = await res.json();
                
                if (!data.auth_url) {
                    alert('OAuth URL alƒ±namadƒ±. .env dosyasƒ±nda GOOGLE_CLIENT_ID kontrol edin.');
                    return;
                }
                
                // Open OAuth popup
                const width = 600;
                const height = 700;
                const left = (screen.width - width) / 2;
                const top = (screen.height - height) / 2;
                
                const popup = window.open(
                    data.auth_url,
                    'Gmail OAuth2 Login',
                    `width=${width},height=${height},left=${left},top=${top},scrollbars=yes`
                );
                
                // Listen for OAuth success message
                const messageHandler = async (event) => {
                    if (event.data.type === 'oauth-success') {
                        popup?.close();
                        window.removeEventListener('message', messageHandler);
                        
                        const tokens = event.data.tokens;
                        
                        // Save account with OAuth tokens to database
                        const accountData = {
                            provider: 'gmail',
                            email: email,
                            display_name: 'Gmail Account',
                            imap_host: 'imap.gmail.com',
                            imap_port: 993,
                            smtp_host: 'smtp.gmail.com',
                            smtp_port: 587,
                            auth_method: 'oauth2',
                            oauth_access_token: tokens.accessToken,
                            oauth_refresh_token: tokens.refreshToken,
                            oauth_expires_at: tokens.expiresAt,
                            credentials_encrypted: btoa(`${email}:oauth2_token`)
                        };
                        
                        try {
                            const saveRes = await fetch('/accounts', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(accountData)
                            });
                            
                            const result = await saveRes.json();
                            
                            if (result.success || result.id) {
                                alert(`‚úÖ Gmail OAuth2 ba≈üarƒ±lƒ±!\n\n${email} hesabƒ± eklendi.\n\n≈ûimdi mesajlarƒ±nƒ±zƒ± senkronize edebilirsiniz!`);
                                
                                // Clear form
                                document.getElementById('new-email').value = '';
                                
                                // Reload accounts
                                await loadAccounts();
                                
                                // Switch to accounts tab
                                document.querySelector('[data-tab="accounts"]').click();
                            } else {
                                alert('Hesap kaydedilemedi: ' + (result.error || 'Unknown error'));
                            }
                        } catch (e) {
                            alert('Hesap kaydetme hatasƒ±: ' + e.message);
                        }
                    }
                };
                
                window.addEventListener('message', messageHandler);
                
            } catch (e) {
                alert('OAuth hatasƒ±: ' + e.message);
            }
        }
        }
        // Initialize
        loadAccounts();
    // Provider mantƒ±ƒüƒ± devre dƒ±≈üƒ±: √ßaƒürƒ± kaldƒ±rƒ±ldƒ±

    // JMAP Test Functions
    function testJmapConnection() {
        // Use backend proxy to avoid CORS
        const apiUrl = '/jmap';
         const token = document.getElementById('jmap-api-token').value;
         const resultDiv = document.getElementById('jmap-test-result');
         resultDiv.style.display = 'block';
         resultDiv.textContent = 'Testing JMAP connection...';
         fetch('/jmap/session', {
             method: 'GET',
             headers: {
                 'Authorization': 'Bearer ' + token,
                 'Accept': 'application/json'
             }
         })
         .then(response => response.json())
         .then(data => {
             resultDiv.textContent = JSON.stringify(data, null, 2);
             if (data.accounts) {
                 const keys = Object.keys(data.accounts);
                 if (keys.length > 0) {
                     document.getElementById('jmap-account-id').value = keys[0];
                 }
             }
         })
         .catch(err => {
             resultDiv.textContent = 'Error: ' + err;
         });
     }
 
     function testJmapInbox() {
        const apiUrl = '/jmap';
         const token = document.getElementById('jmap-api-token').value;
         const accountId = document.getElementById('jmap-account-id').value;
         const resultDiv = document.getElementById('jmap-test-result');
         resultDiv.style.display = 'block';
         resultDiv.textContent = 'Fetching inbox...';
         const body = {
             "using": [
                 "urn:ietf:params:jmap:core",
                 "urn:ietf:params:jmap:mail"
             ],
             "methodCalls": [
                 [
                     "Mailbox/query",
                     {"accountId": accountId, "filter": {"role": "inbox"}},
                     "a"
                 ],
                 [
                     "Email/query",
                     {"accountId": accountId, "filter": {}, "limit": 10},
                     "b"
                 ]
             ]
         };
         fetch(apiUrl, {
             method: 'POST',
             headers: {
                 'Authorization': 'Bearer ' + token,
                 'Content-Type': 'application/json',
                 'Accept': 'application/json'
             },
             body: JSON.stringify(body)
         })
         .then(response => response.json())
         .then(data => {
             resultDiv.textContent = JSON.stringify(data, null, 2);
         })
         .catch(err => {
             resultDiv.textContent = 'Error: ' + err;
         });
     }
         // Subject decode helper (fixes ReferenceError)
    function decodeSubject(subject) {
        try {
            return decodeURIComponent(escape(subject));
        } catch (e) {
            return subject;
        }
    }
    </script>
</body>
</html>
